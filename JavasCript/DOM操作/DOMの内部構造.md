# DOMの内部構造と仕組み
## DOM（Document Object Model）の本質
**HTML → DOMの変換**
- ブラウザはサーバーから受け取ったHTMLを解析してDOMに変換する
- DOMはHTMLの内容をプログラムから扱いやすい形にしたもの
- DOMを操作することで、JavaScriptでページの表示を変えられる

**DOMはメモリ上に保存される**
- 仕様書に従って、DOMはブラウザのメモリに保存される
- 表面上は「キーと値（Key-Value）」形式で情報を保持していると考える

**DOMは木構造（ツリー構造）**
- HTMLのタグ同士の入れ子構造をDOMでも表現するためにツリー構造にする
- 「DOMツリー」と呼ばれる
- ツリー構造により、親子関係や兄弟関係が明確になる

## DOMの構造
**ノード（Node）**
- DOMは「ノード」の集合で構成される

**主なノードの種類：**
①要素ノード（Element Node） → HTMLタグなど
②テキストノード（Text Node） → タグ内の文字列、スペース、改行も含む
③コメントノード（Comment Node） → コメント

ノードはすべてKey-Valueのオブジェクト形式で保存されている


```bash
HTML
 ├─ <!DOCTYPE html>          ← ドキュメントタイプノード
 ├─ <html>                    ← HTML要素ノード
 │    ├─ <head>               ← HEAD要素ノード
 │    │    ├─ <meta>          ← メタタグノード
 │    │    └─ <title>         ← タイトルノード
 │    └─ <body>               ← BODY要素ノード
 │         ├─ <div>           ← 要素ノード
 │         │    └─ テキストノード
 │         └─ <p>             ← 要素ノード
 │              └─ テキストノード


#「ノードの関係」
#親ノード：直上のノード
#子ノード：直下のノード
#兄弟ノード：同じ親を持つノード
#子孫ノード：あるノードの下にあるすべてのノード
#祖先ノード：親・親の親…上方向のノード

#「HTML補正ルール」
#<html>、<head>、<body> がなくてもブラウザは自動生成
#閉じタグがない場合も自動補正
#BODYタグの上に書いた内容 → BODYの先頭に移動
#BODYタグの下に書いた内容 → BODYの末尾に移動
#まとめ：ブラウザは不完全なHTMLでも表示できるよう補正する
```

```bash
JavaScript
 └─ document (ドキュメントオブジェクト)
       ├─ getElementById / querySelector
       │     └─ 対象ノード（分身）
       ├─ createElement / appendChild
       │     └─ DOMノードに反映
       └─ 返り値
             ├─ ノードオブジェクト → DOMとリンク
             └─ 通常オブジェクト → DOMとは関係ない

#document はグローバルオブジェクト
#JavaScriptで操作したノードは、DOMノードとリンクしている
#コンソールの $0 などはELEMENTSタブで選択した要素に対応
```

**タグの情報**
各タグは以下の情報を保持：
- タグ名（例：HTML, HEAD, BODY）
- 属性（例：id, class）
- メソッド（仕様書で定義されたインターフェースに従う）
- テキストやコメントも同じくオブジェクトとして保持

**関係性**
- タグ同士の関係（親子・兄弟）は木構造で管理
- ツリー構造の順番は、DOM作成時にルートから深さ優先で左から右へ作られる

## DOM作成時の仕様上の注意点
**改行やスペース**
- タグ間の改行・スペースもテキストノードとして保存される
- ただし、HEADタグより前のスペースや改行は無視される

**DOCTYPE（ドックタイプ）**
- HTMLがどのバージョンに従って書かれたかを示す
- DOMツリーでは、HTMLタグより上に特別なルートノードとして配置される
- 書かない場合、古いブラウザ互換モードになり、新しい機能が動かない可能性あり

**実装差**
- DOMの内部メモリ構造の管理はブラウザごとに異なる
- 仕様書は「抽象的な動作」だけを定義している
- Google Chromeなどは内部的にクラスを使って実装している


## DOMとノードの基本
**ノードとは？**
- HTMLを解析して作られるKEY-VALUEのデータの塊を仕様書では「ノード」と呼ぶ

**ノードは種類ごとに名前がつく：**
- テキストノード → 文字列
- コメントノード → コメント
- ドキュメントタイプノード → <!DOCTYPE>
- 要素ノード → HTMLタグ（英語ではElement）
- ルート部分はドキュメントノードと呼ぶ

**ノードの親子関係**
- 親ノード：1つ上のノード
- 子ノード：あるノードの直下のノード
- 兄弟ノード：同じ親を持つノード
- 子孫ノード：あるノードの下の全ノード
- 祖先ノード：あるノードの親、親の親…上方向にすべて

**DOMを確認できるツール**
- DOMビューアー
  - 「LIVEDOMビューアー」などを使うとHTMLから生成されたDOMツリーを確認できる

- ノードの詳細まで出るわけではなく、ざっくりの構造（HEAD要素、BODY要素、テキストなど）を確認可能

**メタタグとビューポート**
＝ビューポートとは：ブラウザが「画面幅を何ピクセルとして扱うか」を決める仕組み
→ 小さいスマホ画面でもPC用サイトを正しく表示するために必要

**ビューポートの仕組み**
- iPhone登場時に導入された機能
- 画面の横幅を何ピクセルとして扱うかを決める
- 実際の画面幅と異なる値を指定可能 → 表示を縮小・拡大して調整

例：
- iPhoneの横幅 375px
- width=980 とすると、ブラウザは「横幅980px」と認識 → 横幅が凝縮される
- デバイスピクセルとCSSピクセルは異なる
- window.devicePixelRatio で1ピクセルに使われる画素数を確認できる

**CHARSET（文字コード）**
- HTML文字をコンピューターで正しく扱うために必須
- UTF-8など文字コードを指定する

**HTMLの自動補正**
- ブラウザは不完全なHTMLでも自動でDOMを補正
- `<html>、<head>、<body>`がなくても自動生成
- 閉じタグがなくても自動で補正（ただし構造によっては入れ子になる場合あり）
- BODYタグの上や下に書かれた内容は自動でBODYに入る
  - 上にある場合 → BODYの先頭
  - 下にある場合 → BODYの末尾

まとめ：HTMLは基本的に正しく書くことが推奨される

**JavaScriptからのDOM操作**
- ドキュメントオブジェクト
web APIsのdocument はグローバルオブジェクトとして利用可能
HTMLの`documentType`と、`document`は基本同じ

- ドキュメントノードとほぼ同じインターフェース
変更はDOMに反映され、DOMの変更はJavaScriptに反映される

- ノード取得と操作
document.getElementById, querySelectorなどでノードにアクセス
返り値は「DOMノードの分身」として扱う
本物のDOMノードにリンクしている
オブジェクトの操作はJavaScriptエンジン経由でDOMに反映される

**ブラウザの開発者ツール**
- ELEMENTSタブでDOMを視覚化
- コンソールからdocumentを操作可能
- 特定の要素をクリックして選択すると簡単に取得 ($0, $1 …)


## まとめ
**DOMとは？**
- HTMLをプログラムが扱いやすい形に変換したメモリ上のデータ構造

**構造のポイント**
- ノード（要素・テキスト・コメント）
- キーとバリューで情報を保存
- 木（ツリー）構造でタグの入れ子関係を保持

**JavaScriptの役割**
- HTMLを直接変更するのではなく、DOMを操作することで表示を更新する

**DOMのノードは階層構造で親子・兄弟関係を持つ**

**ビューポート設定がないと、iPhone Safariは自動で横幅980pxに設定**

**BODYタグの上下に書いた内容は自動でBODYに収まる**

**DOM操作はJavaScriptから行えるが、返り値は「分身」であることを理解する**

**一言で言うと:**
- HTMLはブラウザ内で「プログラムから扱いやすい木構造（DOM）に変換される」
→ JavaScriptはこのDOMをいじることで画面を操作できる