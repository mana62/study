# laravel + js (ドラッグ&ドロップ)

## Sortable.jsとは
→ リストのアイテムをドラッグ&ドロップで並び替える機能を簡単に実装できるJavaScriptライブラリ

---

## 参考
- [動いて楽しい！LaravelとSortable.jsで並び替え機能を実装してみる] https://your-school.jp/sortable/682/
- [SortableJSでかんたんリスト並び替え] https://zenn.dev/sdkfz181tiger/articles/e5979cde0238c1

---

### ①ライブラリを導入
```js
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
```

### ②HTMLの要素を準備
```html
<div id="taskList">
    @foreach($tasks as $task)
    <!-- 並び替え後にIDを取得するときは data-idとしておくとgood -->
        <div class="task-item" data-id="{{ $task->id }}">
            {{ $task->name }}
        </div>
    @endforeach
</div>
```

### ③JSの準備
```js
new Sortable(document.getElementById('taskList') {
    // ドラッグ時の動きの速度指定
    animation: 150,
    onEnd: function (evt) { // ドラッグ終了時 (ドラッグ時に何かしたいときは関数を置く)
        const item = Array.from(evt.to.children).map(el => el.dataset.id);
        // onEndで並び順を取得して、サーバーに送るのが基本パターン
        // 送信データは配列にして渡すのがgood

                    // ajaxでバックエンドに情報を送る
                    fetch("/plan-details/reorder", {
                            method: "POST",
                            headers: {
                                'X-CSRF-TOKEN': '{{ csrf_token() }}',
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                item
                            })
                        })
                        .then(res => res.json())
                        .then(data => console.log(data))
                        .catch(error => console.error("エラー:", error));
                },
});
```

③web.phpのルート設定
```php
Route::post('/plan-details/reorder', [PlansController::class, 'reorder']);
// 非同期部分でフロントとバックで通信するため
```

④laravelのコントローラで保存
```php
public function reorder(Request $request)
{
    // $requestからitemを取得
    $order = $request->input('item'); // 配列[3,1,2,...]

    // 配列一個一個の要素を取得して更新($index => $id ➡️ key => value)
    foreach ($item as $index => $id) {
        PlanDetail::where('id', $id)->update(['sort_order' => $index]); // sort_orderは表示順カラム
    }
    return response()->json(['status' => 'success']); // バックエンドからフロントエンドへ処理が成功したよと伝えるための返却処理
}
```