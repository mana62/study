# TDD

---

## テスト書き方

- Arrange(準備)、Act(実行)、Assert(検証)

```php
function test_aaa()
{
    // Arrange（準備）
    $user = User::factory()->create();

    // Act（実行）
    $response = $this
        ->actingAs($user)
        ->get('/');

    // Assert（検証）
    $response->assertStatus(200);
}
```

---

## `$this` と `$response` の違い

- **「$this」** ： テストクラス自体を指す （状態を検証）
- **「$response」**： HTTPリクエストの結果（レスポンス）（表示を検証）


| 要素         | `$this`                                                                 | `$response`                                             |
| ------------ | ----------------------------------------------------------------------- | ------------------------------------------------------- |
| 正体         | テストクラス自身                                                        | HTTPリクエストの結果（レスポンス）                      |
| 役割         | テストの実行者として、DBや認証などを検証                                | 実際の画面やAPIの出力内容を検証                         |
| 使う場面     | DB・認証・例外・モデルなどの状態確認                                    | HTML・JSON・ビュー・セッションなどの表示確認            |
| 代表メソッド | `assertDatabaseHas()`<br>`assertAuthenticated()`<br>`expectException()` | `assertSeeText()`<br>`assertJson()`<br>`assertViewIs()` |


---

## setUp() と tearDown()

- **「setUp()」**：同一クラス内の各テスト（テストメソッド）毎の最初に呼ばれる
- **「tearDown()」** ：各テスト毎の最後に呼ばれる

```php
    protected function setUp(): void // test_sample1()、test_sample2()の各テストの最初に呼ばれる
    {
        parent::setUp();

        dump('setUp');
    }

    protected function tearDown(): void // test_sample1()、test_sample2()の各テストの最後に呼ばれる
    {
        dump('tearDown');

        parent::tearDown();
    }

    public function test_sample1(): void
    {
        $response = $this->get('/');

        dump('sample1');

        $response->assertStatus(200);
    }

    public function test_sample2(): void
    {
        $response = $this->get('/');

        dump('sample2');

        $response->assertStatus(200);
    }
```
---

## ミドルウェアを無効化にする方法

- **「$this->withoutMiddleware();」**： 特定のテストメソッド内に書くと、そのテストの実行中だけミドルウェアが無効化される

```php
class PostManageControllerTest extends TestCase
{
    public function test_自分のブログは削除できる()
    {
        $this->withoutMiddleware();

    }
}
```

### 使用する場面
- 認証やCSRFなどのミドルウェアがテストの本質に関係ないとき
- 「バリデーションだけを検証したい」「レスポンス構造だけを確認したい」など