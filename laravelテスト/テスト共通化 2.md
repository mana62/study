# 共通化できるテスト
- 共通化できる部分がある場合は、共通のテスト等を作成する(トレイト（Trait）など)

---

### 構成
```php
tests/
├── Traits/
│   └── CrudTestTrait.php   ← 共通CRUDテスト
├── Feature/
│   ├── CustomerTest.php    ← use CrudTestTrait
│   ├── ReqTest.php         ← use CrudTestTrait
│   ├── InqTest.php         ← use CrudTestTrait
│   └── EmpTest.php         ← use CrudTestTrait
```

---

### ①共通処理を作る

```php
<?php

namespace Tests\Traits;

use Illuminate\Foundation\Testing\RefreshDatabase;

/**
 * CRUD操作の共通テストトレイト
 * 
 * 使い方:
 * 1. テストクラスで use CrudTestTrait;
 * 2. setUp() で設定を定義
 * 3. 共通メソッドを呼び出す
 */
trait CrudTestTrait
{
    use RefreshDatabase;

    /**
     * テスト対象の設定
     * 各テストクラスの setUp() で上書きする
     */
    protected $resourceName = 'customers';  // URL用の名前
    protected $modelClass;                   // モデルクラス
    protected $tableName = 'member';         // テーブル名
    protected $displayName = '顧客';         // 画面表示名
    protected $type = 'customer';            // member.type の値

    /**
     * 一覧表示のテスト
     */
    public function test_index_page_displays()
    {
        // テストデータを3件作成
        $this->modelClass::factory()->count(3)->create(['type' => $this->type]);

        $response = $this->get("/{$this->resourceName}");
        
        $response->assertStatus(200);
        $response->assertSee($this->displayName); // 例: 「顧客」が表示される
    }

    /**
     * 新規登録画面が表示されるテスト
     */
    public function test_create_page_displays()
    {
        $response = $this->get("/{$this->resourceName}/register");
        
        $response->assertStatus(200);
        $response->assertSee("{$this->displayName}登録");
    }

    /**
     * 新規登録のテスト
     */
    public function test_can_create_record()
    {
        $data = $this->getCreateData();

        $response = $this->post("/{$this->resourceName}", $data);
        
        $response->assertRedirect("/{$this->resourceName}");
        
        // データベースに保存されているか確認
        $this->assertDatabaseHas($this->tableName, array_merge(
            ['type' => $this->type],
            $this->getDbCheckData($data)
        ));
    }

    /**
     * 必須項目バリデーションのテスト
     */
    public function test_required_fields_validation()
    {
        $response = $this->post("/{$this->resourceName}", []);
        
        $response->assertSessionHasErrors($this->getRequiredFields());
    }

    /**
     * メールアドレス形式バリデーションのテスト
     */
    public function test_email_format_validation()
    {
        $data = $this->getCreateData();
        $data['email'] = 'invalid-email'; // 不正な形式

        $response = $this->post("/{$this->resourceName}", $data);
        
        $response->assertSessionHasErrors('email');
    }

    /**
     * 詳細表示のテスト
     */
    public function test_show_page_displays()
    {
        $record = $this->modelClass::factory()->create(['type' => $this->type]);

        $response = $this->get("/{$this->resourceName}/{$record->id}");
        
        $response->assertStatus(200);
        $response->assertSee($record->name);
    }

    /**
     * 存在しないIDで404エラーのテスト
     */
    public function test_show_page_returns_404_for_invalid_id()
    {
        $response = $this->get("/{$this->resourceName}/99999");
        
        $response->assertStatus(404);
    }

    /**
     * 編集画面が表示されるテスト
     */
    public function test_edit_page_displays()
    {
        $record = $this->modelClass::factory()->create(['type' => $this->type]);

        $response = $this->get("/{$this->resourceName}/{$record->id}/edit");
        
        $response->assertStatus(200);
        $response->assertSee($record->name);
    }

    /**
     * 編集のテスト
     */
    public function test_can_update_record()
    {
        $record = $this->modelClass::factory()->create(['type' => $this->type]);
        $updateData = $this->getUpdateData();

        $response = $this->put("/{$this->resourceName}/{$record->id}", $updateData);
        
        $response->assertRedirect("/{$this->resourceName}/{$record->id}");
        
        $this->assertDatabaseHas($this->tableName, array_merge(
            ['id' => $record->id],
            $this->getDbCheckData($updateData)
        ));
    }

    /**
     * 削除のテスト（論理削除）
     */
    public function test_can_delete_record()
    {
        $record = $this->modelClass::factory()->create(['type' => $this->type]);

        $response = $this->delete("/{$this->resourceName}/{$record->id}");
        
        $response->assertRedirect("/{$this->resourceName}");
        
        // 論理削除されているか確認
        $this->assertDatabaseHas($this->tableName, [
            'id' => $record->id,
            'delflag' => 1  // または deleted_at IS NOT NULL
        ]);
    }

    /**
     * 検索機能のテスト
     */
    public function test_can_search_by_name()
    {
        // 検索対象のデータ
        $target = $this->modelClass::factory()->create([
            'type' => $this->type,
            'name' => '検索テスト太郎'
        ]);

        // 検索対象外のデータ
        $other = $this->modelClass::factory()->create([
            'type' => $this->type,
            'name' => '別の人'
        ]);

        $response = $this->get("/{$this->resourceName}?name=検索テスト");
        
        $response->assertStatus(200);
        $response->assertSee('検索テスト太郎');
        $response->assertDontSee('別の人');
    }

    /**
     * CSV出力のテスト
     */
    public function test_can_download_csv()
    {
        $this->modelClass::factory()->count(3)->create(['type' => $this->type]);

        $response = $this->get("/{$this->resourceName}/download");
        
        $response->assertStatus(200);
        $response->assertHeader('content-type', 'text/csv; charset=UTF-8');
    }

    /**
     * ページネーションのテスト
     */
    public function test_pagination_works()
    {
        // 30件作成（1ページ20件と仮定）
        $this->modelClass::factory()->count(30)->create(['type' => $this->type]);

        // 1ページ目
        $response = $this->get("/{$this->resourceName}");
        $response->assertStatus(200);

        // 2ページ目
        $response = $this->get("/{$this->resourceName}?page=2");
        $response->assertStatus(200);
    }

    // ===================================
    // 以下は各テストクラスで上書きする
    // ===================================

    /**
     * 新規登録用のテストデータ
     * 各テストクラスで上書きする
     */
    protected function getCreateData(): array
    {
        return [
            'name' => '山田太郎',
            'email' => 'test@example.com',
            'phone' => '090-1234-5678',
        ];
    }

    /**
     * 更新用のテストデータ
     * 各テストクラスで上書きする
     */
    protected function getUpdateData(): array
    {
        return [
            'name' => '山田花子',
            'email' => 'updated@example.com',
            'phone' => '090-9876-5432',
        ];
    }

    /**
     * データベース確認用のデータ
     * 各テストクラスで上書きする
     */
    protected function getDbCheckData(array $data): array
    {
        return [
            'name' => $data['name'],
            'email' => $data['email'],
        ];
    }

    /**
     * 必須フィールドのリスト
     * 各テストクラスで上書きする
     */
    protected function getRequiredFields(): array
    {
        return ['name', 'email'];
    }
}
```

---

### ②顧客部分

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use Tests\Traits\CrudTestTrait;
use App\Models\Customer;

class CustomerTest extends TestCase
{
    use CrudTestTrait;

    /**
     * テスト前の初期設定
     * ここで共通Traitの設定を上書きする
     */
    protected function setUp(): void
    {
        parent::setUp();

        // 顧客用の設定
        $this->resourceName = 'customers';   // URL
        $this->modelClass = Customer::class; // モデル
        $this->tableName = 'member';         // テーブル
        $this->displayName = '顧客';         // 画面表示名
        $this->type = 'customer';            // typeカラムの値
    }

    /**
     * 新規登録用データ（顧客特有の項目があれば追加）
     */
    protected function getCreateData(): array
    {
        return [
            'name' => '山田太郎',
            'email' => 'test@example.com',
            'phone' => '090-1234-5678',
            'address' => '東京都渋谷区',
            'entrance_date' => '2025-01-01', // 顧客特有の項目
        ];
    }

    /**
     * 更新用データ
     */
    protected function getUpdateData(): array
    {
        return [
            'name' => '山田花子',
            'email' => 'updated@example.com',
            'phone' => '090-9876-5432',
            'address' => '東京都新宿区',
        ];
    }

    /**
     * データベース確認用（保存される値を指定）
     */
    protected function getDbCheckData(array $data): array
    {
        return [
            'name' => $data['name'],
            'email' => $data['email'],
            'phone' => $data['phone'],
        ];
    }

    /**
     * 必須項目（顧客特有）
     */
    protected function getRequiredFields(): array
    {
        return ['name', 'email', 'phone'];
    }

    // ===================================
    // 顧客独自のテストがあればここに追加
    // ===================================

    /**
     * 入校日変更時の再計算テスト（顧客だけの機能）
     */
    public function test_entrance_date_recalculation()
    {
        $customer = Customer::factory()->create([
            'type' => 'customer',
            'entrance_date' => '2025-01-01',
        ]);

        $response = $this->put("/customers/{$customer->id}", [
            'name' => $customer->name,
            'email' => $customer->email,
            'entrance_date' => '2025-02-01', // 変更
        ]);

        $this->assertDatabaseHas('member', [
            'id' => $customer->id,
            'entrance_date' => '2025-02-01',
            // 保険加入日なども再計算されているか確認
        ]);
    }
}

// これだけ！たった60行で15個のテストが実行される！
// Traitで定義した以下のテストが全部使える：
// - test_index_page_displays
// - test_create_page_displays
// - test_can_create_record
// - test_required_fields_validation
// - test_email_format_validation
// - test_show_page_displays
// - test_show_page_returns_404_for_invalid_id
// - test_edit_page_displays
// - test_can_update_record
// - test_can_delete_record
// - test_can_search_by_name
// - test_can_download_csv
// - test_pagination_works
// + 顧客独自のテスト1つ
```

### ③資料請求
```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use Tests\Traits\CrudTestTrait;
use App\Models\MaterialRequest;

class MaterialRequestTest extends TestCase
{
    use CrudTestTrait;

    /**
     * 資料請求用の設定
     */
    protected function setUp(): void
    {
        parent::setUp();

        $this->resourceName = 'requests';        // URL変更
        $this->modelClass = MaterialRequest::class; // モデル変更
        $this->tableName = 'member';             // 同じテーブル
        $this->displayName = '資料請求';          // 表示名変更
        $this->type = 'req';                     // type変更
    }

    /**
     * 資料請求用データ
     */
    protected function getCreateData(): array
    {
        return [
            'name' => '鈴木三郎',
            'email' => 'suzuki@example.com',
            'phone' => '070-5555-6666',
            'request_type' => 'catalog', // 資料請求特有
        ];
    }

    protected function getUpdateData(): array
    {
        return [
            'name' => '鈴木花子',
            'email' => 'suzuki2@example.com',
            'phone' => '070-7777-8888',
        ];
    }

    protected function getDbCheckData(array $data): array
    {
        return [
            'name' => $data['name'],
            'email' => $data['email'],
        ];
    }

    protected function getRequiredFields(): array
    {
        return ['name', 'email'];
    }

    // ===================================
    // 資料請求独自のテスト
    // ===================================

    /**
     * 問い合わせへ移動するテスト
     */
    public function test_can_move_to_inquiry()
    {
        $request = MaterialRequest::factory()->create(['type' => 'req']);

        $response = $this->post("/requests/{$request->id}/move", [
            'move_to' => 'inq'
        ]);

        $response->assertRedirect('/inquiries');

        $this->assertDatabaseHas('member', [
            'id' => $request->id,
            'type' => 'inq',
        ]);
    }
}

// これも同じく60行で15個のテストが動く！
```

---

### ④問い合わせ
```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use Tests\Traits\CrudTestTrait;
use App\Models\Inquiry;

class InquiryTest extends TestCase
{
    use CrudTestTrait;

    /**
     * 問い合わせ用の設定
     */
    protected function setUp(): void
    {
        parent::setUp();

        $this->resourceName = 'inquiries';  // URL変更
        $this->modelClass = Inquiry::class; // モデル変更
        $this->tableName = 'member';        // 同じテーブル
        $this->displayName = '問い合わせ';   // 表示名変更
        $this->type = 'inq';                // type変更
    }

    /**
     * 問い合わせ用データ
     */
    protected function getCreateData(): array
    {
        return [
            'name' => '佐藤次郎',
            'email' => 'sato@example.com',
            'phone' => '080-1111-2222',
            'inquiry_content' => 'お問い合わせ内容', // 問い合わせ特有
        ];
    }

    protected function getUpdateData(): array
    {
        return [
            'name' => '佐藤花子',
            'email' => 'sato2@example.com',
            'phone' => '080-3333-4444',
            'inquiry_content' => '更新後の内容',
        ];
    }

    protected function getDbCheckData(array $data): array
    {
        return [
            'name' => $data['name'],
            'email' => $data['email'],
        ];
    }

    protected function getRequiredFields(): array
    {
        return ['name', 'email', 'inquiry_content'];
    }

    // ===================================
    // 問い合わせ独自のテスト
    // ===================================

    /**
     * 顧客へ移動するテスト（問い合わせだけの機能）
     */
    public function test_can_move_to_customer()
    {
        $inquiry = Inquiry::factory()->create(['type' => 'inq']);

        $response = $this->post("/inquiries/{$inquiry->id}/move", [
            'move_to' => 'customer'
        ]);

        $response->assertRedirect('/customers');

        // typeが変更されているか確認
        $this->assertDatabaseHas('member', [
            'id' => $inquiry->id,
            'type' => 'customer',
        ]);
    }
}

// これも60行で15個のテストが動く！
// 設定を変えるだけでOK！
```