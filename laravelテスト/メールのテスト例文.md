# メールのテスト(例)

## 重複防止・ログ
**同じ人に重複して送信されない**
```php
public function test_同じ宛先に重複して送信されない()
{
    $user = User::factory()->create(['email' => 'test@example.com']);
    Mail::fake();

    // 1回目送信
    $this->sendMailTo($user);

    // 2回目送信（重複防止ロジックが働くはず）
    $this->sendMailTo($user);

    Mail::assertSent(MyMail::class, 1); // 1回しか送られてないことを確認
}
```
- ※ sendMailTo() は送信処理を呼び出すメソッド（テスト用に定義）

**配信ログが正しく記録される**
```php
public function test_配信ログが記録される()
{
    $user = User::factory()->create();
    $this->sendMailTo($user);

    $this->assertDatabaseHas('mail_logs', [
        'email' => $user->email,
        'status' => 'success',
    ]);
}
```

**送信失敗時にエラーが処理される**
```php
public function test_送信失敗時にエラーログが記録される()
{
    Mail::fake();
    Mail::shouldReceive('to')->andThrow(new \Exception('SMTP Error'));

    $user = User::factory()->create();

    try {
        $this->sendMailTo($user);
    } catch (\Exception $e) {
        // 例外をキャッチしてログに記録する処理がある前提
    }

    $this->assertDatabaseHas('mail_logs', [
        'email' => $user->email,
        'status' => 'failed',
    ]);
}
```

## リトライ
**配信失敗時に自動リトライされる**
- Laravelのジョブクラスに tries と backoff を設定しておく

| プロパティ | 意味                                     | 例                         |
|------------|------------------------------------------|----------------------------|
| tries      | ジョブが失敗したときの最大リトライ回数   | 3 回まで再試行される       |
| backoff    | ジョブ失敗後に次の試行まで待つ秒数       | 10 秒待ってから再試行     |


```php
class SendMailJob implements ShouldQueue
{
    public $tries = 3;
    public $backoff = 10;

    public function handle()
    {
        // メール送信処理
    }
}
テストでは Bus::fake() を使ってジョブが再試行されるか確認！
```

```php
public function test_送信失敗時にリトライされる()
{
    Bus::fake();

    $user = User::factory()->create();
    SendMailJob::dispatch($user);

    Bus::assertDispatched(SendMailJob::class);
}
```

**リトライ回数上限に達すると停止する**
- failed() メソッドを使って、失敗後の処理をテスト

```php
public function test_リトライ上限でジョブが停止する()
{
    $job = new SendMailJob($user);
    $job->fail(new \Exception('SMTP Error'));

    $this->assertDatabaseHas('mail_logs', [
        'email' => $user->email,
        'status' => 'failed',
        'retries' => 3,
    ]);
}
```