# Laravel 認証系
- Policy : モデルに対する認可
- Gate : モデルに関係のない認可



| 種類                     | 意味               | チェック対象    | どこに書く？                             | 例                |
| ---------------------- | ---------------- | --------- | ---------------------------------- | ---------------- |
| **認証（Authentication）** | 誰なのか？            | ユーザーの本人確認 | ミドルウェア（`auth`）                     | ログインしてる？         |
| **認可（Authorization）**  | 何をしていいか？         | 権限の有無     | Policy や Gate（AuthServiceProvider） | 投稿を削除していい？       |
| **ミドルウェア（Middleware）** | 「リクエストの通過チェック」全般 | ルート単位の条件  | `app/Http/Middleware` やルート設定       | ログイン済みのみ、管理者のみなど |

---

## ① 認可（Authorization）とは
- 認可は、「このユーザーがこの操作をしていいか？」をチェックする仕組み
- Laravelでは主に Gate と Policy の2種類の方法で設定する

#### Gate（単発的なルール）
- AuthServiceProvider に直接書く

```php
# app/Providers/AuthServiceProvider.php

use Illuminate\Support\Facades\Gate;

public function boot()
{
    Gate::define('edit-post', function ($user, $post) {
        return $user->id === $post->user_id;
    });
}
```
```php
# Controllerで使う
public function update(Post $post)
{
    $this->authorize('edit-post', $post);
    // or Gate::authorize('edit-post', $post);

    // 処理...
}
```

**Gateは「軽い・簡単な認可チェック」に便利**

#### Policy（モデルごとのルールセット）
`php artisan make:policy PostPolicy --model=Post`

```php
# PostPolicy
public function delete(User $user, Post $post)
{
    return $user->id === $post->user_id;
}
```
```php
# AuthServiceProvider に登録

protected $policies = [
    Post::class => PostPolicy::class,
];
```

```php
# Controllerで使う
$this->authorize('delete', $post);
```

**Policyは「モデル単位の認可ルール管理」に最適**

---

## ② Middleware（ミドルウェア）とは
- ミドルウェアは「ルート全体に共通の条件をかける」仕組み

```php
# 例えば
Route::middleware('auth')->group(function () {
    Route::get('/dashboard', [DashboardController::class, 'index']);
});
```
- これは「ログインしてない人はダメ」っていう「認証（Authentication）」チェック
- 権限で使うミドルウェアもある
- Laravelには canミドルウェア もある

```php
Route::delete('/posts/{post}', [PostController::class, 'destroy'])
    ->middleware('can:delete,post');
```
- 内部的には $this->authorize('delete', $post); と同じ動作

---

## ③ 認可とミドルウェアの違いをイメージで
| レイヤー                | 何を守ってる？ | 主な使い方                |
| ------------------- | ------- | -------------------- |
| **ミドルウェア**          | ルートの入口  | 「ログインしてる？」「管理者だけ通して」 |
| **認可（Gate/Policy）** | 実際の処理   | 「この投稿を削除できるのは本人だけ」   |


#### 実際の流れ
①ユーザーが投稿を削除しようとすると <br>
1️⃣ ミドルウェア：ログインしてる？（authチェック）<br>
　→ 未ログインならリダイレクト <br>

2️⃣ 認可：投稿の所有者？（authorizeチェック） <br>
　→ 投稿者本人じゃなければ403 Forbidden <br>

3️⃣ 処理実行（OKなら削除）<br>

---

## ④「can」と「Gate」の違い

| 名前       | 種類        | 使う場所                        | 意味                | 使い方の例                                                         |
| -------- | --------- | --------------------------- | ----------------- | ------------------------------------------------------------- |
| **Gate** | 認可の“定義”   | `AuthServiceProvider` やコード内 | 権限ルールを登録・確認       | `Gate::define()` / `Gate::allows()`                           |
| **can**  | 認可の“チェック” | コントローラ・Blade・ミドルウェアなど       | GateやPolicyを実際に使う | `$user->can('edit-post', $post)` / `@can('edit-post', $post)` |

**Gate は「ルールを定義するもの」** : ルールを「定義」する
**can は「Gate（やPolicy）を使って実際に通るか確認」** : そのルールを「呼び出して使う」

---

## Gate の基本構文
- App\Providers\AuthServiceProvider の boot() メソッド内で定義

#### Gate の定義
```bash
use Illuminate\Support\Facades\Gate;

public function boot()
{
    Gate::define('update-post', function ($user, $post) {
        return $user->id === $post->user_id;
    });
}
```
- 'update-post' → Gate の名前（任意）
- $user → 現在ログイン中のユーザー
- $post → チェック対象のモデル
- return true/false で許可・拒否を返す

#### Gate の呼び出し (コントローラ & Blade)
```bash
# コントローラ
if (Gate::allows('update-post', $post)) {
    // 更新可能
} else {
    abort(403);
}
```

```bash
# Blade
@can('update-post', $post)
    <button>編集</button>
@endcan
```
---

## Policy の基本構文
- Policy は特定のモデル用にルールをまとめたクラス

#### 作成コマンド
```bash
php artisan make:policy PostPolicy --model=Post
```

#### Policy のメソッド例
```php
class PostPolicy
{
    public function update(User $user, Post $post)
    {
        return $user->id === $post->user_id;
    }

    public function delete(User $user, Post $post)
    {
        return $user->id === $post->user_id;
    }
}
```
- メソッド名は Gate と同じく「操作名」を表す
- 引数は $user, $model が基本

#### Policy の呼び出し (コントローラ & Blade)
```php
# コントローラ
$this->authorize('update', $post); // 成功すれば処理続行、失敗すれば 403
```

```php
# Blade
@can('update', $post)
    <button>編集</button>
@endcan
```

---

| 項目   | Gate                      | Policy                 |
| ---- | ------------------------- | ---------------------- |
| 定義場所 | AuthServiceProvider       | 個別の Policy クラス         |
| 対象   | 単発のチェック                   | モデル単位でまとめて管理           |
| 呼び出し | `Gate::allows()` / `@can` | `authorize()` / `@can` |
| メリット | 簡単なルールに便利                 | モデル単位で整理、可読性・再利用性が高い   |


---

## Laravel Gate & Policy メソッド一覧

#### Gate専用メソッド（Facade）

| メソッド             | 説明 |
|----------------------|------|
| `Gate::define()`     | 権限ルールをクロージャで定義する |
| `Gate::allows()`     | 権限があるかどうかを判定（true/false） |
| `Gate::denies()`     | 権限がないかどうかを判定（true/false） |
| `Gate::check()`      | `allows()` とほぼ同じ |
| `Gate::authorize()`  | 権限がなければ例外（403）を投げる |
| `Gate::forUser()`    | 特定ユーザーに対して権限判定を行う |

---

#### Policy専用メソッド（モデルに紐づく）

| メソッド名     | 説明 |
|----------------|------|
| `view()`       | モデルの閲覧権限 |
| `create()`     | 作成権限 |
| `update()`     | 更新権限 |
| `delete()`     | 削除権限 |
| `restore()`    | 復元権限（SoftDelete用） |
| `forceDelete()`| 完全削除権限 |

※ これらは Policy クラス内で定義し、Laravelが自動で呼び出す

---

#### Bladeディレクティブ

| ディレクティブ | 説明 |
|----------------|------|
| `@can`         | 権限がある場合に表示 |
| `@cannot`      | 権限がない場合に表示 |
| `@canany`      | 複数の権限のうちどれかがあれば表示 |

---

#### その他関連メソッド

| メソッド         | 説明 |
|------------------|------|
| `$this->authorize()` | コントローラ内で権限チェック（GateまたはPolicy） |
| `Auth::user()->can()` | ユーザーが権限を持っているか判定 |
| `Auth::user()->cannot()` | ユーザーが権限を持っていないか判定 |



---

## ⑤ まとめ
| 名称                      | 機能                  | 書く場所                                      | 例            |
| ----------------------- | ------------------- | ----------------------------------------- | ------------ |
| **Middleware**          | ルートレベルでのアクセス制御      | `routes/web.php` or `app/Http/Middleware` | ログイン必須、管理者専用 |
| **Gate / Policy**       | モデルや処理単位の権限制御       | `AuthServiceProvider` or `app/Policies`   | 投稿編集、削除の制限   |
| **AuthServiceProvider** | Gate / Policy の登録場所 | `app/Providers/AuthServiceProvider.php`   | 認可ルールの定義     |


**Middleware＝「入口チェック」**
**Authorization（Gate / Policy）＝「中身の権限チェック」**


---

## 参考
- [laravelの認可について整理する【Policy・Gate】](https://qiita.com/Masataka_Sugia/items/72c0e680e23eca960ddb)
- [Laravel 10.x 認可](https://readouble.com/laravel/10.x/ja/authorization.html)
- [Laravel Gate(ゲート)、Policy(ポリシー)を完全理解](https://reffect.co.jp/laravel/laravel-gate-policy-understand)
- [Laravel認可における GateとPolicyの扱いについて](https://qiita.com/TK-CLIT/items/f48dbd968c7e42d6378b)
- [LaravelのGateとPolicyの仕組みを理解！認可を使いこなせるようになるために](https://blog.wh-plus.co.jp/entry/2024/11/29/083723)