# リポジトリ クラス

## Repository とは
- **Repository（リポジトリ）**は、「データベース操作（Eloquent）をまとめて管理するクラス」
- Controller や Service が DB 処理で汚れないように整理する役割（別ファイルとしてまとめる）

## Repository を使うメリット
- Controller や Service がスッキリする
- 検索条件を 1 か所にまとめられる
- クエリ操作が何度でも使い回せる
- テストしやすくなる

## Repository の基本構造
```php
class UserRepository
{
    public function findById(int $id)
    {
        return User::find($id);
    }

    public function getAll()
    {
        return User::orderBy('id', 'asc')->get();
    }
}
```

## WHERE と OR の基本
- 基本的な where / orWhere
```php
User::where('status', 1)
    ->orWhere('role', 'admin')
    ->get();
```

```sql
# SQL
WHERE status = 1 OR role = 'admin'
```

→ 単純な OR なので 無名関数は不要

## 無名関数（クロージャ）を使う意味
**結論 : 「括弧（グループ化）」を作るため**

```sql
# SQL の括弧と同じ役割
# この形にしたい時に必要：
WHERE status = 1
AND (name LIKE '%a%' OR email LIKE '%a%')
```

→ これをクロージャで書く

```php
User::where('status', 1)
    ->where(function($q) use ($keyword) {
        $q->where('name', 'LIKE', "%{$keyword}%")
          ->orWhere('email', 'LIKE', "%{$keyword}%");
    })
    ->get();
```

## 無名関数が必要な場面 / 不要な場面まとめ
| 条件                     | 括弧の必要性 | 理由・説明                             |
|--------------------------|--------------|----------------------------------------|
| 単純な OR                | ❌ 不要       | 単純なORだけならグループ化しなくてOK     |
| OR をまとめたい          | ✔️ 必要       | 意図的にまとめるなら括弧が必要           |
| AND + OR 混在            | ✔️ 必須       | 優先順位を明確にしないとバグの元         |
| 検索フォーム             | ✔️ ほぼ必須   | 柔軟な条件が多く、グループ化が重要       |
| 1 個だけ where/orWhere   | ❌ 不要       | 単体ならグループ化しなくても問題なし     |


## Repository でよく使う書き方（実例）
▼ ① キーワード検索（正しいパターン）

```php
class UserRepository
{
    public function searchByKeyword(string $keyword, int $limit = 20)
    {
        return User::where(function ($q) use ($keyword) {
                $q->where('name', 'LIKE', "%{$keyword}%")
                  ->orWhere('email', 'LIKE', "%{$keyword}%");
            })
            ->orderBy('name', 'asc')
            ->limit($limit)
            ->get();
    }
}
```

SQLイメージ

```aql
WHERE (name LIKE '%keyword%' OR email LIKE '%keyword%')
ORDER BY name ASC
LIMIT 20
```

▼ ② 複数条件 + OR（括弧つけないと事故る）

```php
status = active のユーザーだけを検索したい例

User::where('status', 'active')
    ->where(function($q) use ($keyword) {
        $q->where('name', 'LIKE', "%{$keyword}%")
          ->orWhere('email', 'LIKE', "%{$keyword}%");
    })
    ->get();
```

▼ ③ OR を使うだけ（クロージャ不要）

```php
User::where('status', 'active')
    ->orWhere('age', '>', 30)
    ->get();
```

## よくある間違い
❌ 間違い例（クロージャを使わない）
```php
User::where('status', 'active')
    ->where('name', 'LIKE', "%a%")
    ->orWhere('email', 'LIKE', "%a%")
    ->get();
```

SQL ではこう解釈される

```sql
(status = active AND name LIKE "%a%")
OR email LIKE "%a%"
```

→ email に一致する人が全員ヒットする
→ 検索フォームでよく起きるバグ

## クロージャ使用の黄金ルール
- AND と OR を混ぜるときは、原則クロージャ（括弧を作る）


## まとめ
- Repository は DB 操作専用のクラス
- where / orWhere は単純なときはそのまま書く
- 複雑な検索や複数 OR をまとめたい時はクロージャ
- SQL の「括弧」を作るために使う

