# クエリスコープ
→ モデルに条件付きの絞り込みを定義して、簡単に再利用できる仕組み

---

## クエリスコープがやること
- データベースからどう取ってくるか
- WHERE句の条件を部品化
- よく使う検索条件を再利用しやすくする

---

## クエリスコープの書き方
```bash
# app/Models/Post.php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Post extends Model
{
    public function scopePublished($query)
    {
        return $query->where('is_published', true);
    }
}
```
- メソッド名は scope〇〇 の形で定義
- 第一引数 $query はクエリビルダ
- 条件を $query->where(...) で書く

```bash
# 呼び出し方（コントローラなど）
$posts = Post::published()->get();
```
- 呼び出しは scope〇〇 の〇〇部分だけを書いて呼び出す

---

## クエリスコープとサービスクラスの役割の違い

#### クエリスコープ
- **目的**：Modelに定義して、WHERE句の部品化を行う
- **役割**：
  - データ取得条件の共通化
  - 「削除されていない」「今月の」などの条件を再利用可能にする
- **例**：
  - `scopeActive()`
  - `scopeThisMonth()`

#### サービスクラス（ModelServiceなど）
- **目的**：Modelとは別に、ビジネスロジックを独立して管理する
- **役割**：
  - 複雑な計算や判定処理
  - データ移動や手数料計算などの業務ロジック
  - 入校判定などの条件分岐
- **メリット**：
  - 他のコントローラーでも使える
  - 検索条件やビジネスルールの再利用性が高い
  - Modelが肥大化しない

#### 使い分けのポイント

| 項目 | クエリスコープ | サービスクラス |
|------|----------------|----------------|
| 主な役割 | WHERE句の部品化 | 業務ロジックの管理 |
| 定義場所 | Model内 | 独立したクラス |
| 再利用性 | 高い | 高い |
| 処理内容 | 条件絞り込み | 計算・判定・複雑な処理 |
| 例 | `scopeActive()` | `FeeCalculatorService` |

---