# アクセサとミューテタ
- データベースから取得した値を、表示する前に自動で加工してくれる機能
    - アクセサ（Accessor） → データを「取得するとき」に自動で加工
    - ミューテタ（Mutator） → データを「保存するとき」に自動で加工
    - Modelに書くから、どこでも使える
    - アクセサとミューテタは public より protected が推奨
    - protected function email の email 部分はカラム名を置くのが一般的

---

## アクセサ
- DBから値を取り出すときに自動で整形する
  - たとえば、ユーザー名を必ず「最初の文字を大文字」にして返したいとき

---

## 書き方
```bash
class User extends Model
{
    protected function name(): Attribute
    {
        return Attribute::make(
            get: fn ($value) => ucfirst($value), #  アクセサ
        );
    }
}
```

```bash
# 使う時
$user = User::find(1);
echo $user->name; # たとえば "mana" → "Mana" に変換されて出てくる
```

---

## ミューテタ
- モデルに値を「セット（代入）」するときに自動で加工する
  - たとえば、パスワードを自動でハッシュ化したい場合

---

## 書き方
```bash
use Illuminate\Database\Eloquent\Casts\Attribute;
use Illuminate\Support\Facades\Hash;

class User extends Model
{
    protected function password(): Attribute
    {
        return Attribute::make(
            set: fn ($value) => Hash::make($value), # ミューテタ
        );
    }
}
```

```bash
# 使う時
$user = new User();
$user->password = 'secret';
$user->save();

# DBには 'secret' ではなくハッシュ化された値が入る
```

---

## アクセサ＆ミューテタを同時に使う例
```bash
class Product extends Model
{
    protected function price(): Attribute
    {
        return Attribute::make(
            get: fn ($value) => $value / 100,   # cents → dollars に変換(取得時)
            set: fn ($value) => $value * 100,   # dollars → cents に変換(保存時)
        );
    }
}
```

```bash
# 使う時
$product = new Product();
$product->price = 10;   # DBには 1000 が保存される
echo $product->price;   # 10.0 と表示される
```

---

## 基本構文

```bash
use Illuminate\Database\Eloquent\Casts\Attribute;

protected function 属性名(): Attribute
{
    return Attribute::make(
        get: fn($value) => # 取得時の処理,
        set: fn($value) => # 保存時の処理,
    );
}
```
- 取得時の処理や保存時の処理は、PHPで書く必要がある

---

| 種類        | タイミング         | 目的   | 例                               |
| --------- | ------------- | ---- | ------------------------------- |
| **アクセサ**  | 値を**取得**するとき  | 出力整形 | `get: fn($v) => ucfirst($v)`    |
| **ミューテタ** | 値を**セット**するとき | 入力整形 | `set: fn($v) => Hash::make($v)` |


---

## アクセサ・ミューテタの書き方のコツ

#### ① モデル内に書く
- コントローラではなく モデルが責任を持つ
- 「どう保存するか」「どう取得するか」はモデルにまとめる

#### ② 属性名と関数名を一致させる
```bash
protected function name(): Attribute { ... }
# → $user->name に自動適用
```

#### ③ Attributeクラスでまとめる
- get → 取得時
- set → 保存時
- 古い書き方より可読性が高い

#### ④ 複雑な処理は別メソッドに切り出す
```bash
protected function password(): Attribute
{
    return Attribute::make(
        set: fn($value) => $this->hashPassword($value)
    );
}
```

```bash
private function hashPassword($value) {
    return Hash::make($value);
}
```

#### ⑤ コントローラはシンプルに
```bash
User::create([
    'name' => $request->name,
    'password' => $request->password
]);
```

- 名前の整形やパスワードのハッシュ化はモデル側で自動処理される

- イメージ図
```bash
$request → コントローラ → モデル
                     ↘ アクセサ/ミューテタで自動加工
```

---

## 使う場面
- ユーザー名・タイトルなどのフォーマット整形
- パスワードのハッシュ化
- JSONを自動的に配列化 / 配列をJSONに変換
- 金額など単位換算（円↔銭など）


---

## 参考
- [【Laravel】アクセサ、ミューテタの基本のキ](https://qiita.com/hitochan/items/9cd9f2cbbbdd35916a96)