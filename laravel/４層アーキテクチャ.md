# Model、Repository、Controller、Service それぞれの役割
→ 4層アーキテクチャ

---

## 4層アーキテクチャ

| 層                          | 役割                      | Laravelでの対応例                |
| -------------------------- | ----------------------- | --------------------------- |
| **① プレゼンテーション層（UI層）**      | ユーザーとのやりとりを担当（表示・入力）    | Controller ＋ View（Blade） |
| **② アプリケーション層（ビジネスロジック層）** | アプリの中心となる業務処理（ルールや計算など） | Service                  |
| **③ データアクセス層（永続化層）**       | DBなどのデータ操作を担当           | Repository（＋ Model）      |


```bash
[ Controller ]  ← HTTPを受け取る（UI層）
      ↓
[ Service ]     ← ビジネスロジック（アプリケーション層）
      ↓
[ Repository ]  ← データアクセス（DB層）
      ↓
[ Model ]       ← データ構造・属性定義（ドメイン層）
```


---

## 構成

```bash
/app
├── Http
│   └── Controllers
│       └── TaskController.php   ← ユーザーのリクエストを受け取る
│
├── Services
│   └── TaskService.php         ← ビジネスロジックを担う
│
├── Repositories
│   ├── TaskRepositoryInterface.php ← データ取得のルール「設計図」
│   └── TaskRepository.php          ← 実際のデータ操作「ポンプ」

```

---

## メリット
| メリット       | 説明                         |
| ---------- | -------------------------- |
| 責務が明確になる | どの層が何を担当するかが分かる            |
| テストがしやすい | RepositoryやServiceをモック化できる |
| 再利用性が高い  | ビジネスロジックを再利用できる            |
| 保守性が上がる  | 修正箇所を最小限にできる               |


---

## 各層の責務（役割）
#### ① Controller（プレゼンテーション層）
**役割：HTTPのリクエストとレスポンスを扱う**
- ユーザーの入力を受け取る（フォーム、APIなど）
- Serviceを呼び出す（「何をしたいか」だけ指示）
- 結果をビューやJSONで返す
- ※なるべく「ロジック」は書かない

```php
// app/Http/Controllers/UserController.php
public function index()
{
  $users = $this->userService->getActiveUsers();
  return view('users.index', compact('users'));
}
```

#### ② Service（アプリケーション層）
**役割：アプリ全体のビジネスルールをまとめる（業務処理）**
- ControllerとRepositoryの橋渡し
- 「何を」「どういう条件で」行うかを定義
- 複数のRepositoryをまとめたり、条件分岐を行う

```php
// app/Services/UserService.php
namespace App\Services;

use App\Repositories\UserRepository;

class UserService
{
  protected UserRepository $userRepository;

  public function __construct(UserRepository $userRepository)
  {
    $this->userRepository = $userRepository;
  }

  public function getActiveUsers()
  {
    // ビジネスロジック（例：有効ユーザーのみ表示）
    return $this->userRepository->getActiveUsers();
  }
}
```

#### ③ Repository（データアクセス層）
**役割：データベース操作（SQL／Eloquent）を集約**
- where, join, find, create, update などの操作を書く
- モデルを操作する責務をもつ
- 将来DBをMySQL→MongoDBに変えても、ここだけ修正すればOK

```php
// app/Repositories/UserRepository.php
namespace App\Repositories;

use App\Models\User;

class UserRepository
{
  public function getActiveUsers()
  {
    return User::where('is_active', true)->get();
  }

  public function create(array $data)
  {
    return User::create($data);
  }
}
```

#### ④ Model（ドメイン層／エンティティ層）
**役割：テーブル構造・リレーション・属性（アクセサ、スコープ）などを定義**
- テーブルと1対1対応するクラス（Userモデル⇔usersテーブル）
- 「このデータがどういう構造をしているか」を表現する
- データそのものに関する処理を書く（例：スコープ・アクセサ）

```php
// app/Models/User.php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Casts\Attribute;

class User extends Model
{
  protected $fillable = ['name', 'email', 'is_active'];

  // スコープ：アクティブユーザーだけ取得
  public function scopeActive($query)
  {
    return $query->where('is_active', true);
  }

  // アクセサ：名前の最初の文字を大文字にする
  protected function name(): Attribute
  {
    return Attribute::make(
      get: fn($value) => ucfirst($value)
    );
  }
}
```

---

## まとめ

| 層              | 役割                       | 書く処理の例                                  |
| -------------- | ------------------------ | --------------------------------------- |
| **Model**      | テーブル構造・リレーション・基本的なクエリ    | `User::where('is_active', true)->get()` |
| **Repository** | データアクセス（Modelの呼び出しをまとめる） | `return $this->user->active()->get();`  |
| **Service**    | 業務ロジック（アプリのルール）          | 「注文金額の合計を計算して支払い処理をする」                  |
| **Controller** | 入出力の橋渡し（HTTP処理）          | フォーム入力を受け取ってServiceに渡す                  |


---

## 参考
- [Model、Repository、Controller、Serviceとは？基礎から分かりやすく解説！](https://sesera231.com/archives/7465)
- [Controller・Service・Repositoryで理解する三層アーキテクチャ](https://zenn.dev/aki05162525/articles/d8c011ce69cade)
- [Controller・Service・Repositoryの役割](https://qiita.com/saburo555/items/8dbe1e53671aa3ca7593)
- [サービス層とリポジトリパターン](https://10-5.jp/blog-tenfive/17752/)
- [コントローラー・サービス・リポジトリの役割と配置場所をわかりやすく解説！初心者向けSpringアーキテクチャ入門](https://springboot.jp/spring/boot-structure/153)